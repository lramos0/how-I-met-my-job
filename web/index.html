<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>üìÑ Resume Parser Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body class="bg-light">
    <div class="container py-5">
        <h2 class="text-center fw-bold mb-4">üìÑ Resume Parser Dashboard</h2>

        <!-- Upload Section -->
        <div class="card p-4 shadow-sm mb-4">
            <h5 class="fw-bold mb-3">Upload Your Resume</h5>
            <input type="file" id="resumeFile" class="form-control mb-3" accept=".pdf,.docx">
            <button class="btn btn-primary" onclick="parseResume()">üöÄ Parse Resume</button>
            <p id="statusMsg" class="mt-3 text-muted"></p>
        </div>

        <!-- Preview Section -->
        <div id="previewSection" class="card p-4 shadow-sm d-none">
            <h5 class="fw-bold mb-3">üßæ Resume Preview</h5>

            <div id="parsedOutput" class="bg-light p-3 border rounded small"></div>

            <div class="text-end mt-4">
                <button class="btn btn-success me-2" onclick="downloadJSON()">üíæ Download JSON</button>
                <button class="btn btn-primary" onclick="goToJobsPage()">‚û°Ô∏è Continue to Job Matching</button>
            </div>
            <p id="json-error" class="error" style="display:none;"></p>
        </div>
    </div>

    <script>
        let resumeJSON = null;
        async function sendJSON(json) {
            const jsonError = document.getElementById("json-error");
            const status = document.getElementById("status");
            const output = document.getElementById("response-output");

            jsonError.style.display = "none";

            let bodyObj;
            try {
                const jsonString = typeof json === "string" ? json.trim() : JSON.stringify(json);
                bodyObj = jsonString ? JSON.parse(jsonString) : {};
            } catch (e) {
                jsonError.textContent = "Invalid JSON: " + e.message;
                jsonError.style.display = "block";
                return null;  // Return null in case of invalid JSON
            }

            function setStatus(msg) {
                if (status) {
                    status.textContent = msg || "";
                }
            }

            function setOutput(obj) {
                if (output) {
                    try {
                        output.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
                    } catch {
                        output.textContent = String(obj);
                    }
                }
            }

            setStatus("Sending...");
            setOutput("Awaiting response...");

            try {
                const response = await fetch("/.netlify/functions/classify-cv", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(bodyObj)
                });

                const text = await response.text();
                let jsonResponse;

                try {
                    jsonResponse = JSON.parse(text);  // Try parsing JSON response
                    setOutput(jsonResponse);
                } catch {
                    setOutput(text);  // If not JSON, display raw response
                }

                if (!response.ok) {
                    setStatus(`Error ${response.status}`);
                    return null;  // Return null if response is not OK
                } else {
                    setStatus("Done");
                    return jsonResponse;  // Return the parsed JSON response
                }
            } catch (err) {
                setStatus("Network error");
                setOutput(String(err));
                return null;  // Return null in case of network error
            }
        }

        async function parseResume() {
            const fileInput = document.getElementById("resumeFile");
            const status = document.getElementById("statusMsg");

            if (!fileInput.files.length) {
                alert("Please upload a resume file first.");
                return;
            }

            const file = fileInput.files[0];
            status.textContent = `Reading ${file.name} ...`;

            // Simulated parsing delay
            await new Promise(r => setTimeout(r, 1000));

            // Mock parsed data (replace with real logic)
            resumeJSON = {"inputs":[{"candidate_id":"CAND-2025","full_name":"Avery Patel","location":"Seattle, WA","education_level":"Master","years_experience":5.0,"skills":["Python","Spark","a","b","c","TensorFlow","AWS","Docker"],"certifications":["AWS Solutions Architect"],"current_title":"ML Engineer","industries":["Software","FinTech"],"achievements":["Open source contributor"]}],"password":"craig123"};

            // Call sendJSON and await the result
            const response = await sendJSON(resumeJSON);
            console.log(response);  // Log the response for debugging

            if (response) {
                status.textContent = "‚úÖ Resume parsed successfully!";

                // Update the parsed output with the response
                document.getElementById("parsedOutput").innerHTML = `
                    <b>Name:</b> ${resumeJSON.name}<br>
                    <b>Email:</b> ${resumeJSON.email}<br>
                    <b>Phone:</b> ${resumeJSON.phone}<br>
                    <b>Education:</b> ${resumeJSON.education}<br>
                    <b>Experience:</b> ${resumeJSON.experience}<br>
                    <b>Skills:</b> ${resumeJSON.skills.join(", ")}<br>
                    <b>Certifications:</b> ${resumeJSON.certifications.join(", ")}<br>
                    <b>Competitiveness:</b> ${response.competitiveness || 'N/A'}
                `;

                // Show the preview section
                document.getElementById("previewSection").classList.remove("d-none");
            } else {
                // Handle the case where sendJSON returns null (error or invalid response)
                status.textContent = "‚ùå Something went wrong!";
            }
        }



        function downloadJSON() {
            if (!resumeJSON) {
                alert("Please parse the resume first.");
                return;
            }
            const blob = new Blob([JSON.stringify(resumeJSON, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "parsed_resume.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function goToJobsPage() {
            if (!resumeJSON) {
                alert("Parse resume before continuing.");
                return;
            }
            localStorage.setItem("parsedResume", JSON.stringify(resumeJSON));
            window.location.href = "jobs.html";
        }
    </script>
</body>

</html>