<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>üìÑ Resume Parser Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body class="bg-light">
    <div class="container py-5">
        <h2 class="text-center fw-bold mb-4">üìÑ Resume Parser Dashboard</h2>

        <!-- Upload Section -->
        <div class="card p-4 shadow-sm mb-4">
            <h5 class="fw-bold mb-3">Upload Your Resume</h5>
            <input type="file" id="resumeFile" class="form-control mb-3" accept=".pdf,.docx">
            <button class="btn btn-primary" onclick="parseResume()">üöÄ Parse Resume</button>
            <p id="statusMsg" class="mt-3 text-muted"></p>
        </div>

        <!-- Preview Section -->
        <div id="previewSection" class="card p-4 shadow-sm d-none">
            <h5 class="fw-bold mb-3">üßæ Resume Preview</h5>

            <div id="parsedOutput" class="bg-light p-3 border rounded small"></div>

            <div class="text-end mt-4">
                <button class="btn btn-success me-2" onclick="downloadJSON()">üíæ Download JSON</button>
                <button class="btn btn-primary" onclick="goToJobsPage()">‚û°Ô∏è Continue to Job Matching</button>
            </div>
            <p id="json-error" class="error" style="display:none;"></p>
        </div>
    </div>

    <script>

        async function sendJSON(json) {
          const jsonError = document.getElementById("json-error");
          const status = document.getElementById("status");
          const output = document.getElementById("response-output");

          // Helpers
          const setStatus = (msg) => { if (status) status.textContent = msg || ""; };
          const setOutput = (obj) => {
            if (!output) return;
            try {
              output.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
            } catch {
              output.textContent = String(obj);
            }
          };

          // Reset error banner
          if (jsonError) {
            jsonError.style.display = "none";
            jsonError.textContent = "";
          }

          // Normalize input to an object (or bail with a clear error)
          let bodyObj;
          try {
            const jsonString = typeof json === "string" ? json.trim() : JSON.stringify(json);
            bodyObj = jsonString ? JSON.parse(jsonString) : {};
          } catch (e) {
            if (jsonError) {
              jsonError.textContent = "Invalid JSON: " + e.message;
              jsonError.style.display = "block";
            }
            return null;
          }

          setStatus("Sending‚Ä¶");
          setOutput("Awaiting response‚Ä¶");

          try {
            const response = await fetch("/.netlify/functions/classify-cv", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(bodyObj)
            });

            // Read as text first; parse JSON only if possible
            const text = await response.text();
            let jsonResponse = null;
            try { jsonResponse = text ? JSON.parse(text) : null; } catch { /* non-JSON body */ }

            if (!response.ok) {
              setStatus(`Error ${response.status}`);
              setOutput(jsonResponse ?? text ?? "No response body");
              return null;
            }

            setStatus("Done");
            setOutput(jsonResponse ?? text);
            return jsonResponse ?? text;
          } catch (err) {
            setStatus("Network error");
            setOutput(String(err));
            return null;
          }
        }

        async function parseResume() {
          const fileInput = document.getElementById("resumeFile");
          const status = document.getElementById("statusMsg");

          if (!fileInput?.files?.length) {
            alert("Please upload a resume file first.");
            return;
          }

          const file = fileInput.files[0];
          if (status) status.textContent = `Reading ${file.name} ‚Ä¶`;

          // Simulated parsing delay (replace with real parsing)
          await new Promise((r) => setTimeout(r, 1000));

          // Mock parsed data (replace with your actual parsing result)
          resumeJSON = {
            inputs: [{
              candidate_id: "CAND-2025",
              full_name: "Avery Patel",
              location: "Seattle, WA",
              education_level: "Master",
              years_experience: 5.0,
              skills: ["Python", "Spark", "a", "b", "c", "TensorFlow", "AWS", "Docker"],
              certifications: ["AWS Solutions Architect"],
              current_title: "ML Engineer",
              industries: ["Software", "FinTech"],
              achievements: ["Open source contributor"]
            }],
            password: "craig123"
          };

          console.log("Mock resume data:", resumeJSON);

          // Send to backend
          const response = await sendJSON(resumeJSON);
          console.log("Backend response:", response);

          if (response) {
            if (status) status.textContent = "‚úÖ Resume parsed successfully!";

            const rec = resumeJSON?.inputs?.[0] ?? {};
            console.log("Parsed resume data:", rec);

            document.getElementById("parsedOutput").innerHTML = `
              <b>Name:</b> ${rec.full_name ?? "‚Äî"}<br>
              <b>Location:</b> ${rec.location ?? "‚Äî"}<br>
              <b>Education:</b> ${rec.education_level ?? "‚Äî"}<br>
              <b>Years Experience:</b> ${rec.years_experience ?? "‚Äî"}<br>
              <b>Title:</b> ${rec.current_title ?? "‚Äî"}<br>
              <b>Industries:</b> ${(rec.industries ?? []).join(", ") || "‚Äî"}<br>
              <b>Skills:</b> ${(rec.skills ?? []).join(", ") || "‚Äî"}<br>
              <b>Certifications:</b> ${(rec.certifications ?? []).join(", ") || "‚Äî"}<br>
              <b>Achievements:</b> ${(rec.achievements ?? []).join(", ") || "‚Äî"}<br>
              <b>Competitiveness:</b> ${(response && response.competitiveness) ? response.competitiveness : "N/A"}
            `;

            document.getElementById("previewSection")?.classList.remove("d-none");
          } else {
            if (status) status.textContent = "‚ùå Something went wrong!";
          }
        }


        function downloadJSON() {
            if (!resumeJSON) {
                alert("Please parse the resume first.");
                return;
            }
            const blob = new Blob([JSON.stringify(resumeJSON, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "parsed_resume.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function goToJobsPage() {
            if (!resumeJSON) {
                alert("Parse resume before continuing.");
                return;
            }
            localStorage.setItem("parsedResume", JSON.stringify(resumeJSON));
            window.location.href = "jobs.html";
        }
    </script>
</body>

</html>